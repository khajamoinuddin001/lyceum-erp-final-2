// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Defines the database connection. Prisma will look for the DATABASE_URL
// in your .env file to connect to your PostgreSQL database.
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Defines how the Prisma Client is generated. This creates the code
// you use in your backend to talk to the database.
generator client {
  provider = "prisma-client-js"
}

// --- DATA MODELS ---
// Each model represents a table in your database.

model User {
  id                Int      @id @default(autoincrement())
  name              String
  email             String   @unique
  password          String
  role              String   // Admin, Employee, Student
  permissions       Json?
  mustResetPassword Boolean? @default(false)
  Contact           Contact?
}

model Contact {
  id                      Int      @id @default(autoincrement())
  userId                  Int?     @unique
  user                    User?    @relation(fields: [userId], references: [id])
  name                    String
  contactId               String   @unique
  department              String
  major                   String
  email                   String
  phone                   String
  avatarUrl               String?
  notes                   String?
  agentAssigned           String?
  fileStatus              String?
  checklist               Json? // Array of ChecklistItem
  activityLog             Json? // Array of ContactActivity
  recordedSessions        Json? // Array of RecordedSession
  gpa                     Float?
  advisor                 String?
  courses                 Json? // Array of StudentCourse
  lmsProgress             Json? // Map of courseId to progress
  lmsNotes                Json? // Map of lessonId to note string
  street1                 String?
  street2                 String?
  city                    String?
  state                   String?
  zip                     String?
  country                 String?
  gstin                   String?
  pan                     String?
  tags                    String?
  visaType                String?
  countryOfApplication    String?
  source                  String?
  contactType             String?
  stream                  String?
  intake                  String?
  counselorAssigned       String?
  applicationEmail        String?
  applicationPassword     String?
  createdAt               DateTime @default(now())
  documents               Json? // Array of Document
  visaInformation         Json? // VisaInformation object
}

model CrmLead {
  id          Int          @id @default(autoincrement())
  title       String
  company     String
  value       Float
  contact     String
  stage       String // New, Qualified, Proposal, Won, Lost
  email       String?
  phone       String?
  source      String?
  assignedTo  String?
  notes       String?
  createdAt   DateTime?    @default(now())
  quotations  Quotation[]
}

model Quotation {
  id          Int      @id @default(autoincrement())
  title       String
  description String?
  lineItems   Json // Array of QuotationLineItem
  total       Float
  status      String // Draft, Sent, Accepted, Rejected
  date        String
  leadId      Int
  lead        CrmLead  @relation(fields: [leadId], references: [id], onDelete: Cascade)
}

model QuotationTemplate {
  id          Int    @id @default(autoincrement())
  title       String
  description String?
  lineItems   Json // Array of QuotationLineItem
  total       Float
}

model AccountingTransaction {
  id           String @id
  customerName String
  date         String
  description  String
  type         String // Invoice, Bill, Payment
  status       String // Paid, Pending, Overdue
  amount       Float
}

model Visitor {
  id               Int      @id @default(autoincrement())
  name             String
  company          String
  scheduledCheckIn String
  checkIn          String?
  checkOut         String?
  status           String // Scheduled, CheckedIn, CheckedOut
  host             String
  cardNumber       String?
}

model TodoTask {
  id          Int    @id @default(autoincrement())
  title       String
  description String?
  dueDate     String
  status      String // todo, inProgress, done
}

model CalendarEvent {
  id          Int      @id @default(autoincrement())
  title       String
  start       DateTime
  end         DateTime
  color       String // blue, green, purple, red
  description String?
}

model Channel {
  id       String  @id
  name     String
  messages Json? // Array of Message
  type     String // public, private, dm
  members  Int[]
}

model LmsCourse {
  id           String             @id
  title        String
  description  String
  instructor   String
  price        Float?
  modules      LmsModule[]
  discussions  DiscussionThread[]
}

model LmsModule {
  id        String    @id
  title     String
  courseId  String
  course    LmsCourse @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons   LmsLesson[]
  createdAt DateTime  @default(now())
}

model LmsLesson {
  id          String     @id
  title       String
  content     String
  videoUrl    String?
  attachments Json? // Array of LessonAttachment
  quiz        Json? // Array of QuizQuestion
  moduleId    String
  module      LmsModule  @relation(fields: [moduleId], references: [id], onDelete: Cascade)
}

model DiscussionThread {
  id       String         @id
  title    String
  courseId String
  course   LmsCourse      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  posts    DiscussionPost[]
}

model DiscussionPost {
  id         String           @id
  authorId   Int
  authorName String
  timestamp  String
  content    String
  threadId   String
  thread     DiscussionThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
}

model Coupon {
  code                  String   @id
  discountPercentage    Int
  isActive              Boolean  @default(true)
  applicableCourseIds   String[]
}

model Notification {
  id                Int      @id @default(autoincrement())
  timestamp         String
  title             String
  description       String
  read              Boolean  @default(false)
  linkTo            Json?
  recipientUserIds  Int[]
  recipientRoles    String[]
}

model ActivityLog {
  id        Int      @id @default(autoincrement())
  timestamp String
  adminName String
  action    String
}

model PaymentActivityLog {
  id        Int    @id @default(autoincrement())
  timestamp String
  text      String
  amount    Float
  type      String // invoice_created, payment_received
}
